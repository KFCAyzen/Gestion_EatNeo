rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isSuperAdmin() {
      return isSignedIn() && userDoc().data.role == 'superadmin';
    }

    function isAdmin() {
      return isSignedIn() && (userDoc().data.role == 'admin' || userDoc().data.role == 'superadmin');
    }

    function isOperationalUser() {
      return isSignedIn()
        && (userDoc().data.role == 'admin'
          || userDoc().data.role == 'superadmin'
          || userDoc().data.role == 'user'
          || userDoc().data.role == 'employee');
    }

    function orderKeys() {
      return [
        'items',
        'total',
        'clientPrenom',
        'clientNom',
        'clientPhone',
        'numeroTable',
        'localisation',
        'dateCommande',
        'statut',
        'clientUid',
        'source',
        'syncedAt'
      ];
    }

    function isValidOrderCreate() {
      return request.resource.data.keys().hasOnly(orderKeys())
        && request.resource.data.items is list
        && request.resource.data.total is number
        && request.resource.data.clientPrenom is string
        && request.resource.data.numeroTable is string
        && request.resource.data.localisation is string
        && request.resource.data.statut in ['en_attente', 'en_preparation', 'prete', 'livree']
        && request.resource.data.dateCommande is timestamp
        && (request.resource.data.clientUid is string || request.resource.data.clientUid == null);
    }

    function isValidOrderUpdate() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(['statut'])
        && request.resource.data.statut in ['en_attente', 'en_preparation', 'prete', 'livree'];
    }

    function hasValidNotificationSource() {
      return request.resource.data.source is string
        && request.resource.data.source.size() > 0
        && request.resource.data.source.size() <= 120;
    }

    match /users/{userId} {
      allow read: if isSignedIn() && (userId == request.auth.uid || isSuperAdmin());
      allow create: if isSignedIn() && userId == request.auth.uid;
      allow update: if isSignedIn() && (isSuperAdmin() || (userId == request.auth.uid && request.resource.data.role == resource.data.role));
      allow delete: if isSuperAdmin();
    }

    match /commandes/{orderId} {
      allow create: if isSignedIn() && isValidOrderCreate() && (isOperationalUser() || request.resource.data.clientUid == request.auth.uid);
      allow read: if isSignedIn() && (isOperationalUser() || resource.data.clientUid == request.auth.uid);
      allow update: if isSignedIn() && isOperationalUser() && isValidOrderUpdate();
      allow delete: if isAdmin();
    }

    match /Plats/{docId} {
      allow read: if true;
      allow create, update: if isOperationalUser();
      allow delete: if isAdmin();
    }

    match /Boissons/{docId} {
      allow read: if true;
      allow create, update: if isOperationalUser();
      allow delete: if isAdmin();
    }

    match /ingredients/{docId} {
      allow read: if isOperationalUser();
      allow create, update: if isOperationalUser();
      allow delete: if isAdmin();
    }

    match /mouvements_stock/{docId} {
      allow read: if isOperationalUser();
      allow create: if isOperationalUser();
      allow update, delete: if isAdmin();
    }

    match /notifications/{docId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin() && hasValidNotificationSource();
      allow delete: if isAdmin();
    }

    match /activity_logs/{docId} {
      allow read, create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /depenses/{docId} {
      allow read, create, update, delete: if isAdmin();
    }
  }
}
